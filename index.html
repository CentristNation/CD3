<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposed CD 3 Data Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #007bff;
        }
        
        .main-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
            line-height: 1.3;
        }
        
        .subtitle {
            font-size: 13px;
            color: #666;
            margin: 3px 0 0 0;
        }
        
        .status-message {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 13px;
            border-left: 4px solid #007bff;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }
        
        .selection-tools {
            text-align: center;
        }
        
        .tool-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 3px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .tool-button:hover {
            background: #0056b3;
        }
        
        .tool-button.active {
            background: #28a745;
        }
        
        .filter-item {
            margin-bottom: 12px;
        }
        
        .filter-label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .party-icon {
            width: 20px;
            height: 20px;
            margin-right: 6px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dem-icon { color: #0066cc; }
        .rep-icon { color: #cc0000; }
        
        .filter-slider {
            width: 100%;
            margin: 3px 0;
        }
        
        .filter-value {
            font-size: 11px;
            color: #666;
            text-align: center;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            padding: 3px 0;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        
        .summary-label {
            font-weight: 500;
            color: #555;
        }
        
        .summary-value {
            font-weight: bold;
            color: #333;
        }
        
        .legend {
            position: absolute;
            bottom: 60px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-size: 12px;
        }
        
        .legend h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 13px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        
        .legend-color {
            width: 18px;
            height: 12px;
            margin-right: 6px;
            border: 1px solid #ccc;
        }
        
        .credit {
            position: absolute;
            bottom: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 11px;
            color: #666;
            z-index: 1000;
        }
        
        .mode-info {
            font-size: 10px;
            margin-top: 5px;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <h1 class="main-title">Proposed CD 3 Data Analytics</h1>
                <p class="subtitle">By Ifte Islam PhD</p>
            </div>
            
            <div class="status-message" id="statusMessage">
                üîÑ Loading data...
            </div>
            
            <div class="section" id="selectionSection">
                <div class="section-title">üéØ Selection Tools</div>
                <div class="selection-tools">
                    <button class="tool-button" id="clearSelection" onclick="clearAllSelections()">üóëÔ∏è Clear All</button>
                    <div class="mode-info">Use drawing tools in top-right corner of map</div>
                </div>
            </div>
            
            <div class="section" id="filterSection">
                <div class="section-title">üéØ Filters (Min %)</div>
                
                <div class="filter-item">
                    <div class="filter-label">
                        <div class="party-icon dem-icon">üê¥</div>
                        Democratic %
                    </div>
                    <input type="range" class="filter-slider" id="demSlider" min="0" max="100" value="0">
                    <div class="filter-value" id="demValue">Show areas ‚â• 0%</div>
                </div>
                
                <div class="filter-item">
                    <div class="filter-label">
                        <div class="party-icon rep-icon">üêò</div>
                        Republican %
                    </div>
                    <input type="range" class="filter-slider" id="repSlider" min="0" max="100" value="0">
                    <div class="filter-value" id="repValue">Show areas ‚â• 0%</div>
                </div>
                
                <div class="filter-item">
                    <div class="filter-label">White %</div>
                    <input type="range" class="filter-slider" id="whiteSlider" min="0" max="100" value="0">
                    <div class="filter-value" id="whiteValue">Show areas ‚â• 0%</div>
                </div>
                
                <div class="filter-item">
                    <div class="filter-label">Black %</div>
                    <input type="range" class="filter-slider" id="blackSlider" min="0" max="100" value="0">
                    <div class="filter-value" id="blackValue">Show areas ‚â• 0%</div>
                </div>
                
                <div class="filter-item">
                    <div class="filter-label">Hispanic %</div>
                    <input type="range" class="filter-slider" id="hispanicSlider" min="0" max="100" value="0">
                    <div class="filter-value" id="hispanicValue">Show areas ‚â• 0%</div>
                </div>
                
                <div class="filter-item">
                    <div class="filter-label">Asian %</div>
                    <input type="range" class="filter-slider" id="asianSlider" min="0" max="100" value="0">
                    <div class="filter-value" id="asianValue">Show areas ‚â• 0%</div>
                </div>
            </div>
            
            <div class="section" id="summarySection">
                <div class="section-title">üìä Selected Area Summary</div>
                <div id="summaryContent">
                    <p style="color: #666; text-align: center; font-size: 12px;">Select areas to view data</p>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="legend" id="legend">
                <h4>Democratic %</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #8b0000;"></div>
                    <span>0-20%</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #dc143c;"></div>
                    <span>20-40%</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff6b6b;"></div>
                    <span>40-49%</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4dabf7;"></div>
                    <span>50-60%</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #1864ab;"></div>
                    <span>60%+</span>
                </div>
            </div>
            <div class="credit">PrecinctSmart.com</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.min.js"></script>
    <script>
        let map, geoJsonLayer, selectedFeatures = [];
        let originalData = null;
        let drawnItems = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Starting application...');
            initMap();
        });

        // Initialize map
        function initMap() {
            console.log('üó∫Ô∏è Initializing map...');
            
            map = L.map('map').setView([32.0, -97.0], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            setupDrawingControls();
            loadGeoJSONFromFile();
            
            console.log('‚úÖ Map initialized');
        }

        // Setup Leaflet Draw controls
        function setupDrawingControls() {
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            const drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    polygon: true,
                    rectangle: true,
                    circle: true,
                    polyline: false,
                    marker: false,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            map.addControl(drawControl);

            // Handle drawing events
            map.on(L.Draw.Event.CREATED, function(e) {
                const layer = e.layer;
                drawnItems.addLayer(layer);
                selectFeaturesInDrawnArea(layer);
            });

            map.on(L.Draw.Event.DELETED, function(e) {
                selectedFeatures = [];
                updateSummary();
                resetHighlight();
            });
        }

        // Remove old rectangle functions and replace with draw selection
        function toggleRectangleMode() {
            // This is now handled by Leaflet Draw - remove custom implementation
            updateStatus('‚ÑπÔ∏è Use the drawing tools in the top-right corner of the map');
        }

        function clearAllSelections() {
            selectedFeatures = [];
            drawnItems.clearLayers();
            resetHighlight();
            updateSummary();
        }

        // Load GeoJSON data
        async function loadGeoJSONFromFile() {
            console.log('üìÅ Attempting to load prop3.geojson...');
            updateStatus('üîÑ Loading prop3.geojson...');
            
            try {
                const response = await fetch('prop3.geojson');
                if (response.ok) {
                    const geojson = await response.json();
                    console.log('‚úÖ Loaded external file');
                    updateStatus('‚úÖ Loaded prop3.geojson');
                    processGeoJSON(geojson);
                    return;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è External file not found, using dummy data');
            }
            
            updateStatus('üß™ Using dummy data for testing');
            setTimeout(() => useDummyData(), 500);
        }

        // Update status message
        function updateStatus(message) {
            const statusEl = document.getElementById('statusMessage');
            if (statusEl) {
                statusEl.innerHTML = message;
            }
        }

        // Create dummy data - use decimal format for percentages
        function useDummyData() {
            console.log('üß™ Creating dummy data with decimal percentages...');
            
            const features = [];
            const counties = ["Jefferson", "Harris", "Dallas", "Travis", "Bexar", "Williamson", "Collin", "Fort Bend", "Denton", "Hays", "Brazoria", "Galveston", "Montgomery", "Tarrant", "Bell", "Parker", "Ellis", "Johnson", "Kaufman", "Henderson"];
            const demPercentages = [0.65, 0.672, 0.729, 0.734, 0.671, 0.58, 0.576, 0.573, 0.573, 0.56, 0.49, 0.491, 0.404, 0.446, 0.457, 0.257, 0.302, 0.295, 0.282, 0.274]; // Decimal format!
            
            let id = 1;
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 5; col++) {
                    if (id > 20) break;
                    
                    const lng = -99.0 + (col * 1.0);
                    const lat = 29.0 + (row * 1.0);
                    const county = counties[id - 1];
                    const demPct = demPercentages[id - 1];
                    const dem = Math.round(500 + demPct * 1000);
                    const rep = Math.round(1000 - dem);
                    
                    const coordinates = [[
                        [lng, lat],
                        [lng + 1.0, lat],
                        [lng + 1.0, lat + 1.0],
                        [lng, lat + 1.0],
                        [lng, lat]
                    ]];
                    
                    features.push({
                        "type": "Feature",
                        "properties": {
                            "County": county,
                            "VTD": String(id).padStart(3, '0'),
                            "Dem": dem,
                            "Rep": rep,
                            "Total": dem + rep,
                            "Dem_pct": demPct,  // Decimal format: 0.65 = 65%
                            "Rep_pct": (1 - demPct), // Complement as decimal
                            "White_Vap_pct": 0.5 + Math.random() * 0.3,  // Decimal format
                            "Black_Vap_pct": Math.random() * 0.25,
                            "Asian_Vap_pct": Math.random() * 0.15,
                            "Hispanic_Vap_pct": Math.random() * 0.35,
                            "vap": Math.round((dem + rep) * 1.2),
                            "anglovap": Math.round((dem + rep) * 0.6),
                            "blackvap": Math.round((dem + rep) * 0.15),
                            "hispvap": Math.round((dem + rep) * 0.2),
                            "asianvap": Math.round((dem + rep) * 0.05)
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": coordinates
                        }
                    });
                    
                    console.log(`Created ${county}: Dem_pct=${demPct} (${(demPct*100).toFixed(1)}%)`);
                    id++;
                }
            }
            
            console.log('‚úÖ Created', features.length, 'dummy features with decimal percentages');
            processGeoJSON({"type": "FeatureCollection", "features": features});
        }

        // Process GeoJSON data
        function processGeoJSON(geojson) {
            console.log('üîÑ Processing data...');
            originalData = geojson;
            
            setupFilters();
            loadGeoJSON(geojson);
            updateStatus('‚úÖ Ready - ' + geojson.features.length + ' districts loaded');
            
            console.log('‚úÖ Processing complete');
        }

        // Setup filter sliders
        function setupFilters() {
            const filters = ['dem', 'rep', 'white', 'black', 'hispanic', 'asian'];
            
            filters.forEach(filter => {
                const slider = document.getElementById(filter + 'Slider');
                const value = document.getElementById(filter + 'Value');
                
                if (slider && value) {
                    slider.addEventListener('input', function() {
                        value.textContent = `Show areas ‚â• ${this.value}%`;
                        applyFilters();
                    });
                }
            });
        }

        // Apply filters - handle decimal percentages
        function applyFilters() {
            if (!originalData) return;
            
            const filters = {
                dem: parseInt(document.getElementById('demSlider').value) / 100, // Convert to decimal
                rep: parseInt(document.getElementById('repSlider').value) / 100,
                white: parseInt(document.getElementById('whiteSlider').value) / 100,
                black: parseInt(document.getElementById('blackSlider').value) / 100,
                hispanic: parseInt(document.getElementById('hispanicSlider').value) / 100,
                asian: parseInt(document.getElementById('asianSlider').value) / 100
            };
            
            const filteredData = {
                ...originalData,
                features: originalData.features.filter(feature => {
                    const props = feature.properties;
                    return (props.Dem_pct || 0) >= filters.dem &&
                           (props.Rep_pct || 0) >= filters.rep &&
                           (props.White_Vap_pct || 0) >= filters.white &&
                           (props.Black_Vap_pct || 0) >= filters.black &&
                           (props.Hispanic_Vap_pct || 0) >= filters.hispanic &&
                           (props.Asian_Vap_pct || 0) >= filters.asian;
                })
            };
            
            loadGeoJSON(filteredData);
            selectedFeatures = [];
            updateSummary();
        }

        // Color coding - handle decimal percentages (0.65 = 65%)
        function getColor(demPct) {
            const pct = (parseFloat(demPct) || 0) * 100; // Convert decimal to percentage
            console.log('Coloring polygon with Dem_pct:', demPct, '‚Üí', pct + '%');
            
            if (pct < 20) return '#8b0000';      // Dark red
            if (pct < 40) return '#dc143c';      // Medium red
            if (pct < 49) return '#ff6b6b';      // Light red
            if (pct < 60) return '#4dabf7';      // Light blue
            return '#1864ab';                    // Dark blue
        }

        // Style polygons
        function style(feature) {
            const demPct = parseFloat(feature.properties.Dem_pct) || 0;
            return {
                fillColor: getColor(demPct),
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }

        // Highlight style
        function highlightStyle(feature) {
            return {
                fillColor: getColor(feature.properties.Dem_pct),
                weight: 3,
                color: '#ffff00',
                fillOpacity: 0.9
            };
        }

        // Load GeoJSON onto map
        function loadGeoJSON(geojson) {
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
            }

            geoJsonLayer = L.geoJSON(geojson, {
                style: style,
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    const demPct = (parseFloat(props.Dem_pct) || 0) * 100; // Convert to percentage for display
                    
                    layer.bindTooltip(`
                        <strong>County:</strong> ${props.County || 'N/A'}<br>
                        <strong>VTD:</strong> ${props.VTD || 'N/A'}<br>
                        <strong>Dem %:</strong> ${demPct.toFixed(1)}%
                    `);

                    layer.on('click', function(e) {
                        toggleFeatureSelection(feature, layer);
                        L.DomEvent.stopPropagation(e);
                    });
                }
            }).addTo(map);

            map.fitBounds(geoJsonLayer.getBounds(), {padding: [20, 20]});
        }

        // Select features in drawn area
        function selectFeaturesInDrawnArea(drawnLayer) {
            console.log('üéØ Selecting features in drawn area...');
            selectedFeatures = [];
            
            if (!geoJsonLayer) return;

            geoJsonLayer.eachLayer(function(layer) {
                const feature = layer.feature;
                if (isFeatureInDrawnArea(feature, drawnLayer)) {
                    selectedFeatures.push({feature: feature, layer: layer});
                    layer.setStyle(highlightStyle(feature));
                } else {
                    layer.setStyle(style(feature));
                }
            });
            
            console.log(`Selected ${selectedFeatures.length} features`);
            updateSummary();
        }

        // Check if feature intersects with drawn area
        function isFeatureInDrawnArea(feature, drawnLayer) {
            if (!feature.geometry || !feature.geometry.coordinates) return false;
            
            try {
                const drawnBounds = drawnLayer.getBounds();
                
                if (feature.geometry.type === 'Polygon') {
                    const coords = feature.geometry.coordinates[0];
                    return coords.some(coord => {
                        return drawnBounds.contains([coord[1], coord[0]]);
                    });
                }
                return false;
            } catch (e) {
                console.error('Error in intersection check:', e);
                return false;
            }
        }

        // Toggle feature selection
        function toggleFeatureSelection(feature, layer) {
            const index = selectedFeatures.findIndex(f => f.feature === feature);
            
            if (index > -1) {
                selectedFeatures.splice(index, 1);
                layer.setStyle(style(feature));
            } else {
                selectedFeatures.push({feature: feature, layer: layer});
                layer.setStyle(highlightStyle(feature));
            }
            
            updateSummary();
        }

        // Reset highlights
        function resetHighlight() {
            if (geoJsonLayer) {
                geoJsonLayer.eachLayer(function(layer) {
                    layer.setStyle(style(layer.feature));
                });
            }
        }

        // Update summary
        function updateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            
            if (selectedFeatures.length === 0) {
                summaryContent.innerHTML = '<p style="color: #666; text-align: center; font-size: 12px;">Select areas to view data</p>';
                return;
            }

            const aggregated = aggregateData(selectedFeatures.map(sf => sf.feature.properties));
            
            let html = `<div class="summary-item">
                <span class="summary-label">Selected Areas:</span>
                <span class="summary-value">${selectedFeatures.length}</span>
            </div>`;
            
            Object.entries(aggregated).forEach(([key, value]) => {
                let displayValue;
                if (key.includes('_pct') || key.includes('_Pct')) {
                    // Convert decimal percentages to display format
                    displayValue = `${(value * 100).toFixed(1)}%`;
                } else {
                    displayValue = value.toLocaleString();
                }
                
                html += `<div class="summary-item">
                    <span class="summary-label">${formatLabel(key)}:</span>
                    <span class="summary-value">${displayValue}</span>
                </div>`;
            });
            
            summaryContent.innerHTML = html;
        }

        // Aggregate data
        function aggregateData(propertiesArray) {
            if (propertiesArray.length === 0) return {};
            
            const result = {};
            const sampleProps = propertiesArray[0];
            
            Object.keys(sampleProps).forEach(key => {
                if (key === 'geometry' || key === 'GEOID' || key === 'PCTKEY') return;
                
                const values = propertiesArray.map(p => parseFloat(p[key]) || 0).filter(v => !isNaN(v));
                if (values.length === 0) return;
                
                if (key.includes('_pct') || key.includes('_Pct')) {
                    result[key] = values.reduce((sum, val) => sum + val, 0) / values.length;
                } else if (['Dem', 'Rep', 'Total'].includes(key) || key.endsWith('vap')) {
                    result[key] = values.reduce((sum, val) => sum + val, 0);
                }
            });
            
            return result;
        }

        // Format labels
        function formatLabel(key) {
            return key.replace(/_/g, ' ')
                     .replace(/pct/gi, '%')
                     .replace(/vap/gi, 'VAP')
                     .replace(/\b\w/g, l => l.toUpperCase());
        }
    </script>
</body>
</html>